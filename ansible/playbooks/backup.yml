---
# /app/infra/ansible/playbooks/backup.yml
# 사용: ansible-playbook playbooks/backup.yml
# Cron: 0 3 * * * cd /app/infra/ansible && ansible-playbook playbooks/backup.yml

- name: Daily Backup
  hosts: localhost
  connection: local
  become: yes
  
  vars:
    backup_base: /app/backups
    retention_days: 30
    report_path: /app/infra/reports/backup_status.json
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    date_str: "{{ ansible_date_time.date }}"
    
  tasks:
    # ============================================
    # 디렉토리 생성
    # ============================================
    - name: Create backup directories
      file:
        path: "{{ backup_base }}/{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - salm/daily
        - mgmt/daily
        - db/daily

    # ============================================
    # SALM 백업
    # ============================================
    - name: Backup SALM source
      archive:
        path: /app/salm/salm
        dest: "{{ backup_base }}/salm/daily/salm-{{ date_str }}.tar.gz"
        format: gz
      register: salm_backup
      ignore_errors: yes

    # ============================================
    # Mgmt 백업
    # ============================================
    - name: Backup Mgmt source
      archive:
        path: /app/mgmt/mgmt
        dest: "{{ backup_base }}/mgmt/daily/mgmt-{{ date_str }}.tar.gz"
        format: gz
      register: mgmt_backup
      ignore_errors: yes

    # ============================================
    # Database 백업
    # ============================================
    - name: Backup SALM Database
      shell: |
        source /app/salm/.env 2>/dev/null || true
        DB_PASS=${DB_PASSWORD:-$(grep DB_PASSWORD /app/salm/.env 2>/dev/null | cut -d= -f2)}
        mysqldump -u salm -p"${DB_PASS}" salm 2>/dev/null | gzip > {{ backup_base }}/db/daily/salm-db-{{ date_str }}.sql.gz
      args:
        executable: /bin/bash
      register: salm_db_backup
      ignore_errors: yes

    - name: Backup Mgmt Database
      shell: |
        source /app/mgmt/.env 2>/dev/null || true
        DB_PASS=${DB_PASSWORD:-$(grep DB_PASSWORD /app/mgmt/.env 2>/dev/null | cut -d= -f2)}
        if [ -n "$DB_PASS" ]; then
          mysqldump -u mgmt -p"${DB_PASS}" mgmt 2>/dev/null | gzip > {{ backup_base }}/db/daily/mgmt-db-{{ date_str }}.sql.gz
        fi
      args:
        executable: /bin/bash
      register: mgmt_db_backup
      ignore_errors: yes

    # ============================================
    # 오래된 백업 정리
    # ============================================
    - name: Find old SALM backups
      find:
        paths: "{{ backup_base }}/salm/daily"
        age: "{{ retention_days }}d"
        patterns: "*.tar.gz"
      register: old_salm_backups

    - name: Find old Mgmt backups
      find:
        paths: "{{ backup_base }}/mgmt/daily"
        age: "{{ retention_days }}d"
        patterns: "*.tar.gz"
      register: old_mgmt_backups

    - name: Find old DB backups
      find:
        paths: "{{ backup_base }}/db/daily"
        age: "{{ retention_days }}d"
        patterns: "*.sql.gz"
      register: old_db_backups

    - name: Remove old backups
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_salm_backups.files + old_mgmt_backups.files + old_db_backups.files }}"

    # ============================================
    # 백업 상태 리포트 생성
    # ============================================
    - name: Get SALM backup files
      find:
        paths: "{{ backup_base }}/salm/daily"
        patterns: "*.tar.gz"
      register: salm_files

    - name: Get Mgmt backup files
      find:
        paths: "{{ backup_base }}/mgmt/daily"
        patterns: "*.tar.gz"
      register: mgmt_files

    - name: Get DB backup files
      find:
        paths: "{{ backup_base }}/db/daily"
        patterns: "*.sql.gz"
      register: db_files

    - name: Generate backup status report
      copy:
        content: |
          {
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "salm": {
              "success": {{ 1 if salm_backup is succeeded else 0 }},
              "failed": {{ 0 if salm_backup is succeeded else 1 }},
              "total": {{ salm_files.matched }},
              "files": [
                {% for f in salm_files.files | sort(attribute='mtime', reverse=true) %}
                {
                  "name": "{{ f.path | basename }}",
                  "date": "{{ '%Y-%m-%d' | strftime(f.mtime) }}",
                  "size": "{{ (f.size / 1024 / 1024) | round(2) }}MB",
                  "status": "ok"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
              ]
            },
            "mgmt": {
              "success": {{ 1 if mgmt_backup is succeeded else 0 }},
              "failed": {{ 0 if mgmt_backup is succeeded else 1 }},
              "total": {{ mgmt_files.matched }},
              "files": [
                {% for f in mgmt_files.files | sort(attribute='mtime', reverse=true) %}
                {
                  "name": "{{ f.path | basename }}",
                  "date": "{{ '%Y-%m-%d' | strftime(f.mtime) }}",
                  "size": "{{ (f.size / 1024 / 1024) | round(2) }}MB",
                  "status": "ok"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
              ]
            },
            "db": {
              "success": {{ (1 if salm_db_backup is succeeded else 0) + (1 if mgmt_db_backup is succeeded else 0) }},
              "failed": {{ (0 if salm_db_backup is succeeded else 1) + (0 if mgmt_db_backup is succeeded else 1) }},
              "total": {{ db_files.matched }},
              "files": [
                {% for f in db_files.files | sort(attribute='mtime', reverse=true) %}
                {
                  "name": "{{ f.path | basename }}",
                  "date": "{{ '%Y-%m-%d' | strftime(f.mtime) }}",
                  "size": "{{ (f.size / 1024 / 1024) | round(2) }}MB",
                  "status": "ok"
                }{% if not loop.last %},{% endif %}
                {% endfor %}
              ]
            }
          }
        dest: "{{ report_path }}"
        mode: '0644'

    - name: Display backup summary
      debug:
        msg: |
          ====== Backup Summary ======
          SALM: {{ 'SUCCESS' if salm_backup is succeeded else 'FAILED' }}
          Mgmt: {{ 'SUCCESS' if mgmt_backup is succeeded else 'FAILED' }}
          SALM DB: {{ 'SUCCESS' if salm_db_backup is succeeded else 'FAILED' }}
          Mgmt DB: {{ 'SUCCESS' if mgmt_db_backup is succeeded else 'FAILED' }}
          Report: {{ report_path }}
          ============================
