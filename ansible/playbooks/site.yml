---
# site.yml - ì¸í”„ë¼ ìƒíƒœ ì ê²€ & ë¦¬í¬íŠ¸ ìƒì„±
# ì‹¤í–‰: cd /app/infra/ansible && ansible-playbook playbooks/site.yml

- name: Infrastructure Health Check & Report
  hosts: all
  gather_facts: yes
  vars:
    report_dir: /app/infra/reports
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    
  tasks:
    # ============================================
    # 1. ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
    # ============================================
    - name: Create report directory
      file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'

    - name: Collect system information
      set_fact:
        system_info:
          hostname: "{{ ansible_hostname }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          kernel: "{{ ansible_kernel }}"
          cpu_cores: "{{ ansible_processor_vcpus }}"
          memory_total_mb: "{{ ansible_memtotal_mb }}"
          memory_free_mb: "{{ ansible_memfree_mb }}"
          memory_used_percent: "{{ ((ansible_memtotal_mb - ansible_memfree_mb) / ansible_memtotal_mb * 100) | round(1) }}"
          uptime_seconds: "{{ ansible_uptime_seconds }}"
          uptime_days: "{{ (ansible_uptime_seconds / 86400) | round(1) }}"
          ip_address: "{{ ansible_default_ipv4.address | default('N/A') }}"
          timestamp: "{{ ansible_date_time.iso8601 }}"

    - name: Display system info
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“Š SYSTEM INFORMATION
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Hostname: {{ system_info.hostname }}
          OS: {{ system_info.os }}
          Kernel: {{ system_info.kernel }}
          CPU Cores: {{ system_info.cpu_cores }}
          Memory: {{ system_info.memory_used_percent }}% used ({{ system_info.memory_free_mb }}MB free)
          Uptime: {{ system_info.uptime_days }} days
          IP: {{ system_info.ip_address }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # ============================================
    # 2. ë””ìŠ¤í¬ ìƒíƒœ í™•ì¸
    # ============================================
    - name: Get disk usage
      shell: df -h --output=target,size,used,avail,pcent | grep -E '^/|^Mounted'
      register: disk_usage
      changed_when: false

    - name: Display disk usage
      debug:
        msg: |
          ğŸ’¾ DISK USAGE
          {{ disk_usage.stdout }}

    # ============================================
    # 3. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
    # ============================================
    - name: Check service status - Nginx
      shell: systemctl is-active nginx || echo "inactive"
      register: nginx_status
      changed_when: false
      failed_when: false

    - name: Check service status - Prometheus
      shell: systemctl is-active prometheus || echo "inactive"
      register: prometheus_status
      changed_when: false
      failed_when: false

    - name: Check service status - Grafana
      shell: systemctl is-active grafana-server || echo "inactive"
      register: grafana_status
      changed_when: false
      failed_when: false

    - name: Check service status - Node Exporter
      shell: systemctl is-active node_exporter || echo "inactive"
      register: node_exporter_status
      changed_when: false
      failed_when: false

    - name: Check service status - MariaDB
      shell: systemctl is-active mariadb || echo "inactive"
      register: mariadb_status
      changed_when: false
      failed_when: false

    - name: Collect service statuses
      set_fact:
        services:
          - name: "Nginx"
            status: "{{ nginx_status.stdout }}"
            port: 443
          - name: "Prometheus"
            status: "{{ prometheus_status.stdout }}"
            port: 9090
          - name: "Grafana"
            status: "{{ grafana_status.stdout }}"
            port: 3000
          - name: "Node Exporter"
            status: "{{ node_exporter_status.stdout }}"
            port: 9100
          - name: "MariaDB"
            status: "{{ mariadb_status.stdout }}"
            port: 9981

    - name: Display service status
      debug:
        msg: |
          ğŸ”§ SERVICE STATUS
          {% for svc in services %}
          {{ 'âœ…' if svc.status == 'active' else 'âŒ' }} {{ svc.name }}: {{ svc.status }} (port {{ svc.port }})
          {% endfor %}

    # ============================================
    # 4. í¬íŠ¸ ì—°ê²° í™•ì¸
    # ============================================
    - name: Check port connectivity
      wait_for:
        host: localhost
        port: "{{ item.port }}"
        timeout: 3
        state: started
      loop: "{{ services }}"
      register: port_checks
      ignore_errors: yes

    - name: Summarize port status
      set_fact:
        port_results: "{{ port_results | default([]) + [{'name': item.item.name, 'port': item.item.port, 'reachable': item.failed | default(false) == false}] }}"
      loop: "{{ port_checks.results }}"

    - name: Display port status
      debug:
        msg: |
          ğŸŒ PORT CONNECTIVITY
          {% for p in port_results %}
          {{ 'âœ…' if p.reachable else 'âŒ' }} {{ p.name }} ({{ p.port }}): {{ 'Open' if p.reachable else 'Closed' }}
          {% endfor %}

    # ============================================
    # 5. ìµœê·¼ ì—ëŸ¬ ë¡œê·¸ ìˆ˜ì§‘
    # ============================================
    - name: Get recent Nginx errors (last 10)
      shell: tail -10 /var/log/nginx/error.log 2>/dev/null || echo "No error log"
      register: nginx_errors
      changed_when: false
      failed_when: false

    - name: Get recent system errors (last 10)
      shell: journalctl -p err -n 10 --no-pager 2>/dev/null || echo "No errors"
      register: system_errors
      changed_when: false
      failed_when: false

    # ============================================
    # 6. ì„¤ì • íŒŒì¼ ë°±ì—… (ë³µì‚¬ë§Œ, ë®ì–´ì“°ê¸° X)
    # ============================================
    - name: Create backup directory
      file:
        path: "{{ report_dir }}/backup_{{ timestamp }}"
        state: directory
        mode: '0755'

    - name: Backup Nginx config
      copy:
        src: /etc/nginx/conf.d/
        dest: "{{ report_dir }}/backup_{{ timestamp }}/nginx_conf.d/"
        remote_src: yes
      ignore_errors: yes

    - name: Backup Prometheus config
      copy:
        src: /etc/prometheus/prometheus.yml
        dest: "{{ report_dir }}/backup_{{ timestamp }}/prometheus.yml"
        remote_src: yes
      ignore_errors: yes

    - name: Backup Grafana config
      copy:
        src: /etc/grafana/grafana.ini
        dest: "{{ report_dir }}/backup_{{ timestamp }}/grafana.ini"
        remote_src: yes
      ignore_errors: yes

    # ============================================
    # 7. JSON ë¦¬í¬íŠ¸ ìƒì„±
    # ============================================
    - name: Generate JSON report
      copy:
        content: |
          {
            "report_time": "{{ ansible_date_time.iso8601 }}",
            "system": {
              "hostname": "{{ system_info.hostname }}",
              "os": "{{ system_info.os }}",
              "kernel": "{{ system_info.kernel }}",
              "cpu_cores": {{ system_info.cpu_cores }},
              "memory_total_mb": {{ system_info.memory_total_mb }},
              "memory_free_mb": {{ system_info.memory_free_mb }},
              "memory_used_percent": {{ system_info.memory_used_percent }},
              "uptime_days": {{ system_info.uptime_days }},
              "ip_address": "{{ system_info.ip_address }}"
            },
            "services": [
              {% for svc in services %}
              {"name": "{{ svc.name }}", "status": "{{ svc.status }}", "port": {{ svc.port }}}{{ "," if not loop.last else "" }}
              {% endfor %}
            ],
            "ports": [
              {% for p in port_results %}
              {"name": "{{ p.name }}", "port": {{ p.port }}, "reachable": {{ p.reachable | lower }}}{{ "," if not loop.last else "" }}
              {% endfor %}
            ]
          }
        dest: "{{ report_dir }}/report_{{ timestamp }}.json"

    # ============================================
    # 8. ìµœì¢… ìš”ì•½
    # ============================================
    - name: Count service status
      set_fact:
        active_count: "{{ services | selectattr('status', 'equalto', 'active') | list | length }}"
        total_count: "{{ services | length }}"

    - name: Final summary
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘            ğŸ“‹ INFRASTRUCTURE HEALTH REPORT                â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Server: {{ system_info.hostname | center(45) }}  â•‘
          â•‘  Time: {{ ansible_date_time.iso8601 | center(47) }}  â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Services: {{ active_count }}/{{ total_count }} Active                                    â•‘
          â•‘  Memory: {{ system_info.memory_used_percent }}% Used                                     â•‘
          â•‘  Uptime: {{ system_info.uptime_days }} Days                                      â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ“ Report saved: {{ report_dir }}/report_{{ timestamp }}.json  â•‘
          â•‘  ğŸ“ Backup saved: {{ report_dir }}/backup_{{ timestamp }}/      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Health check completed successfully!
