# .github/workflows/cd.yml
# main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ì„œë²„ ìë™ ë°°í¬

name: Infra Monitoring Project CD

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            cd /app/infra
            
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main
            
            echo "ğŸ”’ Setting permissions..."
            chmod 644 index.html
            chmod -R 755 ansible/
            
            echo "ğŸ” Testing Nginx config..."
            sudo nginx -t
            
            echo "ğŸ”„ Reloading Nginx..."
            sudo systemctl reload nginx
            
            echo "âœ… Deployment completed!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ” Verifying deployment..."
            
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/)
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Dashboard responding (HTTP $HTTP_STATUS)"
            else
              echo "âŒ Dashboard failed (HTTP $HTTP_STATUS)"
              exit 1
            fi
            
            echo ""
            echo "ğŸ“Š Service Status:"
            systemctl is-active nginx && echo "âœ… Nginx: Running"
            systemctl is-active prometheus && echo "âœ… Prometheus: Running"
            systemctl is-active grafana-server && echo "âœ… Grafana: Running"
