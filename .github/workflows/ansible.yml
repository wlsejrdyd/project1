# .github/workflows/ansible.yml
# Ansible í”Œë ˆì´ë¶ ì›ê²© ì‹¤í–‰

name: Ansible

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ
    inputs:
      playbook:
        description: 'Playbook to run'
        required: true
        default: 'site.yml'
        type: choice
        options:
          - site.yml
          - healthcheck.yml
          - backup.yml
          - report.yml
      extra_args:
        description: 'Extra arguments (optional)'
        required: false
        default: ''
        type: string

env:
  ANSIBLE_PATH: /app/project1/ansible

jobs:
  # ============================================
  # Run Ansible Playbook
  # ============================================
  ansible-run:
    name: Run Ansible
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display job info
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       ğŸ”§ ANSIBLE EXECUTION            â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Playbook: ${{ inputs.playbook }}"
          echo "â•‘  Args: ${{ inputs.extra_args || 'None' }}"
          echo "â•‘  Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Run Ansible via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 10m
          script: |
            echo "ğŸš€ Starting Ansible playbook..."
            
            cd ${{ env.ANSIBLE_PATH }}
            
            # Git pull (ìµœì‹  í”Œë ˆì´ë¶)
            git pull origin main 2>/dev/null || true
            
            # Ansible ì‹¤í–‰
            echo ""
            echo "â–¶ï¸ Running: ansible-playbook playbooks/${{ inputs.playbook }} ${{ inputs.extra_args }}"
            echo ""
            
            ansible-playbook playbooks/${{ inputs.playbook }} ${{ inputs.extra_args }}
            
            EXIT_CODE=$?
            
            echo ""
            if [ $EXIT_CODE -eq 0 ]; then
              echo "âœ… Ansible playbook completed successfully!"
            else
              echo "âŒ Ansible playbook failed with exit code $EXIT_CODE"
              exit $EXIT_CODE
            fi

      - name: Upload report (if generated)
        if: inputs.playbook == 'site.yml' || inputs.playbook == 'report.yml'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ“‹ Latest reports:"
            ls -lt /app/project1/reports/*.json 2>/dev/null | head -3 || echo "No JSON reports"
            ls -lt /app/project1/reports/*.html 2>/dev/null | head -3 || echo "No HTML reports"

  # ============================================
  # Summary
  # ============================================
  summary:
    name: Execution Summary
    runs-on: ubuntu-latest
    needs: ansible-run
    if: always()
    
    steps:
      - name: Job result
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š ANSIBLE EXECUTION SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Playbook: ${{ inputs.playbook }}"
          echo "Status: ${{ needs.ansible-run.result }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
