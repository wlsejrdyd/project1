<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Infrastructure Dashboard | infra.deok.kr</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #111827;
      --bg-card: #1f2937;
      --bg-card-hover: #374151;
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.3);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text: #f9fafb;
      --text-muted: #9ca3af;
      --border: #374151;
      --prometheus: #e6522c;
      --grafana: #f46800;
      --kubernetes: #326ce5;
      --salm: #ec4899;
      --mgmt: #8b5cf6;
      --backup: #06b6d4;
    }

    body {
      font-family: 'Segoe UI', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo { display: flex; align-items: center; gap: 12px; }

    .logo-icon {
      width: 42px; height: 42px;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
      box-shadow: 0 4px 15px var(--accent-glow);
    }

    .logo-text { font-size: 1.3rem; font-weight: 700; }

    .header-right { display: flex; align-items: center; gap: 1rem; }

    .external-links { display: flex; gap: 8px; }

    .ext-link {
      padding: 8px 14px; border-radius: 8px;
      font-size: 0.8rem; font-weight: 600;
      text-decoration: none; transition: all 0.2s;
      display: flex; align-items: center; gap: 6px;
    }

    .ext-link.prometheus { background: rgba(230, 82, 44, 0.15); border: 1px solid var(--prometheus); color: var(--prometheus); }
    .ext-link.grafana { background: rgba(244, 104, 0, 0.15); border: 1px solid var(--grafana); color: var(--grafana); }
    .ext-link:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

    .status-badge {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid var(--success);
      border-radius: 20px; font-size: 0.85rem;
    }

    .status-dot {
      width: 8px; height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .current-time { color: var(--text-muted); font-size: 0.85rem; }

    .main { padding: 1.5rem; max-width: 1800px; margin: 0 auto; }

    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem; margin-bottom: 1.5rem; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-bottom: 1.5rem; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.25rem; margin-bottom: 1.5rem; }
    .grid-3-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 1.25rem; margin-bottom: 1.5rem; }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px; padding: 1.5rem;
      transition: all 0.3s;
    }

    .card:hover { border-color: var(--accent); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
    .card.k8s:hover { border-color: var(--kubernetes); }
    .card.backup:hover { border-color: var(--backup); }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }

    .card-title {
      font-size: 0.85rem; color: var(--text-muted);
      font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;
    }

    .card-title.k8s { color: var(--kubernetes); }
    .card-title.backup { color: var(--backup); }

    .card-icon {
      width: 36px; height: 36px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
    }

    .metric-value { font-size: 2.2rem; font-weight: 700; margin-bottom: 0.25rem; }
    .metric-sub { font-size: 0.8rem; color: var(--text-muted); }

    .progress-bar { height: 6px; background: var(--bg-secondary); border-radius: 3px; margin-top: 1rem; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

    .service-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

    .service-item {
      display: flex; align-items: center; gap: 10px;
      padding: 12px; background: var(--bg-secondary);
      border-radius: 10px; transition: background 0.2s;
    }

    .service-item:hover { background: var(--bg-card-hover); }

    .service-icon {
      width: 36px; height: 36px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center; font-size: 1rem;
    }

    .service-name { font-weight: 600; font-size: 0.9rem; }
    .service-port { font-size: 0.75rem; color: var(--text-muted); }

    .service-status { margin-left: auto; width: 10px; height: 10px; border-radius: 50%; }
    .service-status.up { background: var(--success); box-shadow: 0 0 8px var(--success); }
    .service-status.down { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
    .service-status.unknown { background: var(--text-muted); }

    .chart-container { position: relative; height: 220px; }

    .pipeline-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }

    .pipeline-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 12px; background: var(--bg-secondary);
      border-radius: 8px; border-left: 3px solid transparent;
    }

    .pipeline-item.success { border-left-color: var(--success); }
    .pipeline-item.failure { border-left-color: var(--danger); }
    .pipeline-item.pending { border-left-color: var(--warning); }

    .pipeline-icon {
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-size: 0.75rem;
    }

    .pipeline-icon.success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .pipeline-icon.failure { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .pipeline-icon.pending { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

    .pipeline-info { flex: 1; min-width: 0; }
    .pipeline-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pipeline-meta { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
    .pipeline-time { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; }

    .repo-badge {
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: 6px;
    }
    .repo-badge.infra { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
    .repo-badge.salm { background: rgba(236, 72, 153, 0.2); color: var(--salm); }
    .repo-badge.mgmt { background: rgba(139, 92, 246, 0.2); color: var(--mgmt); }

    .repo-filter {
      display: flex; gap: 8px; margin-bottom: 12px;
    }
    .repo-filter-btn {
      padding: 6px 12px; border-radius: 6px;
      font-size: 0.75rem; font-weight: 600;
      background: var(--bg-secondary); border: 1px solid var(--border);
      color: var(--text-muted); cursor: pointer;
      transition: all 0.2s;
    }
    .repo-filter-btn:hover { border-color: var(--accent); }
    .repo-filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .repo-filter-btn.active.salm { background: var(--salm); border-color: var(--salm); }
    .repo-filter-btn.active.mgmt { background: var(--mgmt); border-color: var(--mgmt); }

    .ansible-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 1rem; }
    .ansible-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1rem; }

    .ansible-stat { text-align: center; padding: 12px 8px; background: var(--bg-secondary); border-radius: 10px; }
    .ansible-value { font-size: 1.4rem; font-weight: 700; }
    .ansible-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; }

    .log-console {
      background: #0d1117; border-radius: 8px; padding: 12px;
      font-family: 'JetBrains Mono', 'Consolas', monospace;
      font-size: 0.75rem; max-height: 180px; overflow-y: auto;
    }

    .log-line { padding: 3px 0; display: flex; gap: 8px; }
    .log-time { color: #6e7681; min-width: 70px; }
    .log-ok { color: var(--success); }
    .log-changed { color: var(--warning); }
    .log-failed { color: var(--danger); }
    .log-task { color: var(--text-muted); }
    .log-size { color: var(--backup); margin-left: auto; }

    .loading { color: var(--text-muted); font-style: italic; }

    .section-title {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 1rem; padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .section-title span { font-size: 1.1rem; font-weight: 600; }
    .section-title.k8s span { color: var(--kubernetes); }
    .section-title.backup span { color: var(--backup); }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    @media (max-width: 1200px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-2, .grid-3, .grid-3-1 { grid-template-columns: 1fr; }
      .service-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-icon">üìä</div>
      <span class="logo-text">Infrastructure Dashboard</span>
    </div>
    <div class="header-right">
      <div class="external-links">
        <a href="/prometheus" target="_blank" class="ext-link prometheus">üî• Prometheus</a>
        <a href="/grafana" target="_blank" class="ext-link grafana">üìà Grafana</a>
      </div>
      <div class="status-badge">
        <span class="status-dot"></span>
        <span id="systemStatus">Checking...</span>
      </div>
      <div class="current-time" id="currentTime"></div>
    </div>
  </header>

  <main class="main">
    <!-- Metrics Row -->
    <div class="grid-4">
      <div class="card">
        <div class="card-header">
          <span class="card-title">CPU Usage</span>
          <div class="card-icon" style="background: rgba(59, 130, 246, 0.2); color: var(--accent);">üíª</div>
        </div>
        <div class="metric-value" id="cpuValue">--</div>
        <div class="metric-sub">node_cpu_seconds_total</div>
        <div class="progress-bar">
          <div class="progress-fill" id="cpuBar" style="width: 0%; background: linear-gradient(90deg, var(--accent), #8b5cf6);"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Memory Usage</span>
          <div class="card-icon" style="background: rgba(16, 185, 129, 0.2); color: var(--success);">üß†</div>
        </div>
        <div class="metric-value" id="memValue">--</div>
        <div class="metric-sub">node_memory_Active_bytes</div>
        <div class="progress-bar">
          <div class="progress-fill" id="memBar" style="width: 0%; background: linear-gradient(90deg, var(--success), #34d399);"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Disk Usage</span>
          <div class="card-icon" style="background: rgba(245, 158, 11, 0.2); color: var(--warning);">üíæ</div>
        </div>
        <div class="metric-value" id="diskValue">--</div>
        <div class="metric-sub">node_filesystem_avail_bytes</div>
        <div class="progress-bar">
          <div class="progress-fill" id="diskBar" style="width: 0%; background: linear-gradient(90deg, var(--warning), #fbbf24);"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Uptime</span>
          <div class="card-icon" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6;">‚è±Ô∏è</div>
        </div>
        <div class="metric-value" id="uptimeValue">--</div>
        <div class="metric-sub">node_boot_time_seconds</div>
      </div>
    </div>

    <!-- Services & Chart Row -->
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Service Status</span>
          <span class="card-title" id="serviceUpdateTime" style="font-size: 0.7rem;"></span>
        </div>
        <div class="service-grid" id="serviceGrid"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">CPU Usage (1h)</span>
        </div>
        <div class="chart-container">
          <canvas id="cpuChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Kubernetes Row -->
    <div class="section-title k8s">
      <span>‚ò∏Ô∏è Kubernetes Cluster</span>
    </div>
    <div class="grid-2">
      <div class="card k8s">
        <div class="card-header">
          <span class="card-title k8s">Pods Status</span>
          <span class="card-title" id="k8sUpdateTime" style="font-size: 0.7rem;"></span>
        </div>
        <div class="pipeline-list" id="podList" style="max-height: 280px;">
          <div class="loading">Loading Kubernetes Pods...</div>
        </div>
      </div>

      <div class="card k8s">
        <div class="card-header">
          <span class="card-title k8s">Cluster Overview</span>
        </div>
        <div class="ansible-grid">
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--success);" id="k8sRunning">-</div>
            <div class="ansible-label">Running</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--warning);" id="k8sPending">-</div>
            <div class="ansible-label">Pending</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--danger);" id="k8sFailed">-</div>
            <div class="ansible-label">Failed</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--kubernetes);" id="k8sTotal">-</div>
            <div class="ansible-label">Total Pods</div>
          </div>
        </div>
        <div class="card-header" style="margin-top: 1rem;">
          <span class="card-title k8s">Nodes</span>
        </div>
        <div class="service-grid" id="k8sNodes">
          <div class="loading">Loading nodes...</div>
        </div>
      </div>
    </div>

    <!-- CI/CD Row -->
    <div class="grid-3-1">
      <div class="card">
        <div class="card-header">
          <span class="card-title">CI/CD Pipeline (GitHub Actions)</span>
          <span class="card-title" id="pipelineUpdateTime" style="font-size: 0.7rem;"></span>
        </div>
        <div class="repo-filter">
          <button class="repo-filter-btn active" data-repo="all">All</button>
          <button class="repo-filter-btn" data-repo="infra">üîß Infra</button>
          <button class="repo-filter-btn salm" data-repo="salm">üè† SALM</button>
          <button class="repo-filter-btn mgmt" data-repo="mgmt">‚öôÔ∏è Mgmt</button>
        </div>
        <div class="pipeline-list" id="pipelineList">
          <div class="loading">Loading GitHub Actions...</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">Ansible Execution</span>
          <span class="card-title" id="ansibleUpdateTime" style="font-size: 0.7rem;"></span>
        </div>
        <div class="ansible-grid">
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--success);" id="ansibleOk">-</div>
            <div class="ansible-label">OK</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--warning);" id="ansibleChanged">-</div>
            <div class="ansible-label">Changed</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--danger);" id="ansibleFailed">-</div>
            <div class="ansible-label">Failed</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--text-muted);" id="ansibleSkipped">-</div>
            <div class="ansible-label">Skipped</div>
          </div>
        </div>
        <div class="log-console" id="ansibleLog">
          <div class="loading">Loading Ansible logs...</div>
        </div>
      </div>
    </div>

    <!-- Backup Status Row -->
    <div class="section-title backup">
      <span>üíæ Backup Status</span>
    </div>
    <div class="grid-3">
      <div class="card backup">
        <div class="card-header">
          <span class="card-title backup">üè† SALM Backup</span>
          <span class="card-title" id="salmBackupTime" style="font-size: 0.7rem;"></span>
        </div>
        <div class="ansible-grid-3">
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--success);" id="salmBackupOk">-</div>
            <div class="ansible-label">Success</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--danger);" id="salmBackupFailed">-</div>
            <div class="ansible-label">Failed</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--backup);" id="salmBackupTotal">-</div>
            <div class="ansible-label">Total</div>
          </div>
        </div>
        <div class="log-console" id="salmBackupLog" style="max-height: 140px;">
          <div class="loading">Loading SALM backups...</div>
        </div>
      </div>

      <div class="card backup">
        <div class="card-header">
          <span class="card-title backup">‚öôÔ∏è Mgmt Backup</span>
          <span class="card-title" id="mgmtBackupTime" style="font-size: 0.7rem;"></span>
        </div>
        <div class="ansible-grid-3">
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--success);" id="mgmtBackupOk">-</div>
            <div class="ansible-label">Success</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--danger);" id="mgmtBackupFailed">-</div>
            <div class="ansible-label">Failed</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--backup);" id="mgmtBackupTotal">-</div>
            <div class="ansible-label">Total</div>
          </div>
        </div>
        <div class="log-console" id="mgmtBackupLog" style="max-height: 140px;">
          <div class="loading">Loading Mgmt backups...</div>
        </div>
      </div>

      <div class="card backup">
        <div class="card-header">
          <span class="card-title backup">üóÑÔ∏è Database Backup</span>
          <span class="card-title" id="dbBackupTime" style="font-size: 0.7rem;"></span>
        </div>
        <div class="ansible-grid-3">
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--success);" id="dbBackupOk">-</div>
            <div class="ansible-label">Success</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--danger);" id="dbBackupFailed">-</div>
            <div class="ansible-label">Failed</div>
          </div>
          <div class="ansible-stat">
            <div class="ansible-value" style="color: var(--backup);" id="dbBackupTotal">-</div>
            <div class="ansible-label">Total</div>
          </div>
        </div>
        <div class="log-console" id="dbBackupLog" style="max-height: 140px;">
          <div class="loading">Loading DB backups...</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const CONFIG = {
      prometheusUrl: '/prometheus',
      reportsUrl: '/reports',
      backupReportUrl: '/reports/backup_status.json',
      githubOwner: 'wlsejrdyd',
      githubRepos: [
        { repo: 'infra', label: 'Infra', color: '#3b82f6', icon: 'üîß' },
        { repo: 'salm', label: 'SALM', color: '#ec4899', icon: 'üè†' },
        { repo: 'mgmt', label: 'Mgmt', color: '#8b5cf6', icon: '‚öôÔ∏è' }
      ],
      refreshInterval: 10000
    };

    let allWorkflowRuns = [];
    let currentRepoFilter = 'all';

    const SERVICES = [
      { name: 'Nginx', port: 80, icon: 'üåê', color: 'var(--success)', job: null },
      { name: 'Prometheus', port: 9090, icon: 'üî•', color: 'var(--prometheus)', job: 'prometheus' },
      { name: 'Grafana', port: 3000, icon: 'üìà', color: 'var(--grafana)', job: null },
      { name: 'Node Exporter', port: 9100, icon: 'üì°', color: '#8b5cf6', job: 'node' },
      { name: 'MariaDB', port: 9981, icon: 'üóÑÔ∏è', color: 'var(--accent)', job: null },
      { name: 'Kube State Metrics', port: 30047, icon: '‚ò∏Ô∏è', color: 'var(--kubernetes)', job: 'kube-state-metrics' },
    ];

    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleString('ko-KR', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      });
    }
    setInterval(updateTime, 1000);
    updateTime();

    async function fetchPrometheusMetric(query) {
      try {
        const res = await fetch(`${CONFIG.prometheusUrl}/api/v1/query?query=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (data.status === 'success' && data.data.result.length > 0) {
          return parseFloat(data.data.result[0].value[1]);
        }
      } catch (e) { console.error('Prometheus fetch error:', e); }
      return null;
    }

    async function updateMetrics() {
      const cpu = await fetchPrometheusMetric('100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)');
      if (cpu !== null) {
        document.getElementById('cpuValue').textContent = cpu.toFixed(1) + '%';
        document.getElementById('cpuBar').style.width = cpu + '%';
      }
      const memTotal = await fetchPrometheusMetric('node_memory_MemTotal_bytes');
      const memAvail = await fetchPrometheusMetric('node_memory_MemAvailable_bytes');
      if (memTotal && memAvail) {
        const memUsed = ((memTotal - memAvail) / memTotal * 100);
        document.getElementById('memValue').textContent = memUsed.toFixed(1) + '%';
        document.getElementById('memBar').style.width = memUsed + '%';
      }
      const diskTotal = await fetchPrometheusMetric('node_filesystem_size_bytes{mountpoint="/"}');
      const diskAvail = await fetchPrometheusMetric('node_filesystem_avail_bytes{mountpoint="/"}');
      if (diskTotal && diskAvail) {
        const diskUsed = ((diskTotal - diskAvail) / diskTotal * 100);
        document.getElementById('diskValue').textContent = diskUsed.toFixed(1) + '%';
        document.getElementById('diskBar').style.width = diskUsed + '%';
      }
      const bootTime = await fetchPrometheusMetric('node_boot_time_seconds');
      if (bootTime) {
        const uptimeSec = Date.now() / 1000 - bootTime;
        const days = Math.floor(uptimeSec / 86400);
        const hours = Math.floor((uptimeSec % 86400) / 3600);
        document.getElementById('uptimeValue').textContent = `${days}d ${hours}h`;
      }
    }

    async function updateServiceStatus() {
      const serviceGrid = document.getElementById('serviceGrid');
      let upStatus = {};
      try {
        const res = await fetch(`${CONFIG.prometheusUrl}/api/v1/query?query=up`);
        const data = await res.json();
        if (data.status === 'success') {
          data.data.result.forEach(r => { upStatus[r.metric.job] = r.value[1] === '1'; });
        }
      } catch (e) { console.error('Failed to fetch up status:', e); }
      serviceGrid.innerHTML = SERVICES.map(svc => {
        let status = 'unknown';
        if (svc.job && upStatus[svc.job] !== undefined) status = upStatus[svc.job] ? 'up' : 'down';
        return `<div class="service-item"><div class="service-icon" style="background: ${svc.color}22; color: ${svc.color};">${svc.icon}</div><div><div class="service-name">${svc.name}</div><div class="service-port">:${svc.port}</div></div><div class="service-status ${status}" title="${status.toUpperCase()}"></div></div>`;
      }).join('');
      const allUp = Object.values(upStatus).every(v => v);
      document.getElementById('systemStatus').textContent = allUp ? 'All Systems Operational' : 'Some Issues Detected';
      document.getElementById('serviceUpdateTime').textContent = 'Updated: ' + new Date().toLocaleTimeString('ko-KR');
    }

    async function updateKubernetes() {
      const podList = document.getElementById('podList');
      try {
        const podRes = await fetch(`${CONFIG.prometheusUrl}/api/v1/query?query=kube_pod_status_phase`);
        const podData = await podRes.json();
        let pods = {}, stats = { Running: 0, Pending: 0, Failed: 0, Succeeded: 0, Unknown: 0 };
        if (podData.status === 'success') {
          podData.data.result.forEach(r => {
            const podName = r.metric.pod, namespace = r.metric.namespace, phase = r.metric.phase, value = r.value[1];
            if (value === '1') { pods[`${namespace}/${podName}`] = { name: podName, namespace, phase }; stats[phase] = (stats[phase] || 0) + 1; }
          });
        }
        const podEntries = Object.values(pods);
        if (podEntries.length > 0) {
          podList.innerHTML = podEntries.map(pod => {
            const statusClass = pod.phase === 'Running' ? 'success' : (pod.phase === 'Pending' ? 'pending' : 'failure');
            const statusIcon = pod.phase === 'Running' ? '‚úì' : (pod.phase === 'Pending' ? '‚è≥' : '‚úó');
            return `<div class="pipeline-item ${statusClass}"><div class="pipeline-icon ${statusClass}">${statusIcon}</div><div class="pipeline-info"><div class="pipeline-name">${pod.name}</div><div class="pipeline-meta">${pod.namespace}</div></div><div class="pipeline-time">${pod.phase}</div></div>`;
          }).join('');
        } else { podList.innerHTML = '<div class="loading">No pods found</div>'; }
        document.getElementById('k8sRunning').textContent = stats.Running;
        document.getElementById('k8sPending').textContent = stats.Pending;
        document.getElementById('k8sFailed').textContent = stats.Failed + stats.Unknown;
        document.getElementById('k8sTotal').textContent = podEntries.length;
        const nodeRes = await fetch(`${CONFIG.prometheusUrl}/api/v1/query?query=kube_node_status_condition{condition="Ready",status="true"}`);
        const nodeData = await nodeRes.json();
        const k8sNodes = document.getElementById('k8sNodes');
        if (nodeData.status === 'success' && nodeData.data.result.length > 0) {
          k8sNodes.innerHTML = nodeData.data.result.map(r => {
            const nodeName = r.metric.node, isReady = r.value[1] === '1';
            return `<div class="service-item"><div class="service-icon" style="background: rgba(50, 108, 229, 0.2); color: var(--kubernetes);">üñ•Ô∏è</div><div><div class="service-name">${nodeName}</div><div class="service-port">Node</div></div><div class="service-status ${isReady ? 'up' : 'down'}"></div></div>`;
          }).join('');
        } else { k8sNodes.innerHTML = '<div class="loading">No nodes found</div>'; }
        document.getElementById('k8sUpdateTime').textContent = 'Updated: ' + new Date().toLocaleTimeString('ko-KR');
      } catch (e) { console.error('Failed to fetch Kubernetes metrics:', e); podList.innerHTML = '<div class="loading">Failed to load Kubernetes data</div>'; }
    }

    async function fetchAllWorkflowRuns() {
      const allRuns = [];
      for (const repoConfig of CONFIG.githubRepos) {
        try {
          const res = await fetch(url, { headers: { 'Authorization': `token ${CONFIG.githubToken}` } });
          const data = await res.json();
          if (data.workflow_runs) {
            data.workflow_runs.forEach(run => { allRuns.push({ ...run, _repo: repoConfig.repo, _label: repoConfig.label, _color: repoConfig.color, _icon: repoConfig.icon }); });
          }
        } catch (e) { console.error(`Failed to fetch ${repoConfig.repo}:`, e); }
      }
      allRuns.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      return allRuns;
    }

    function renderPipelineList(runs, filter = 'all') {
      const pipelineList = document.getElementById('pipelineList');
      const filteredRuns = filter === 'all' ? runs : runs.filter(r => r._repo === filter);
      if (filteredRuns.length > 0) {
        pipelineList.innerHTML = filteredRuns.slice(0, 15).map(run => {
          const status = run.conclusion || run.status;
          const statusClass = status === 'success' ? 'success' : (status === 'failure' ? 'failure' : 'pending');
          const statusIcon = status === 'success' ? '‚úì' : (status === 'failure' ? '‚úó' : '‚è≥');
          const timeAgo = getTimeAgo(new Date(run.created_at));
          return `<div class="pipeline-item ${statusClass}"><div class="pipeline-icon ${statusClass}">${statusIcon}</div><div class="pipeline-info"><div class="pipeline-name">${run.name}<span class="repo-badge ${run._repo}">${run._icon} ${run._label}</span></div><div class="pipeline-meta">${run.head_branch} ‚Ä¢ ${run.head_sha.substring(0, 7)} ‚Ä¢ "${run.head_commit?.message?.split('\n')[0] || 'No message'}"</div></div><div class="pipeline-time">${timeAgo}</div></div>`;
        }).join('');
      } else { pipelineList.innerHTML = '<div class="loading">No workflow runs found</div>'; }
      document.getElementById('pipelineUpdateTime').textContent = 'Updated: ' + new Date().toLocaleTimeString('ko-KR');
    }

    async function updatePipeline() {
      allWorkflowRuns = await fetchAllWorkflowRuns();
      renderPipelineList(allWorkflowRuns, currentRepoFilter);
    }

    document.querySelectorAll('.repo-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.repo-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentRepoFilter = btn.dataset.repo;
        renderPipelineList(allWorkflowRuns, currentRepoFilter);
      });
    });

    async function updateAnsibleReport() {
      try {
        const res = await fetch(`${CONFIG.reportsUrl}/`);
        const html = await res.text();
        const jsonFiles = [...html.matchAll(/href="(report_[^"]+\.json)"/g)].map(m => m[1]).sort().reverse();
        if (jsonFiles.length > 0) {
          const latestReport = await fetch(`${CONFIG.reportsUrl}/${jsonFiles[0]}`).then(r => r.json());
          let okCount = 0, failedCount = 0;
          if (latestReport.services) latestReport.services.forEach(svc => { if (svc.status === 'active') okCount++; else failedCount++; });
          if (latestReport.ports) latestReport.ports.forEach(port => { if (port.reachable) okCount++; else failedCount++; });
          document.getElementById('ansibleOk').textContent = okCount;
          document.getElementById('ansibleChanged').textContent = 0;
          document.getElementById('ansibleFailed').textContent = failedCount;
          document.getElementById('ansibleSkipped').textContent = 0;
          const logConsole = document.getElementById('ansibleLog');
          let logHtml = '';
          if (latestReport.services) logHtml += latestReport.services.map(svc => `<div class="log-line"><span class="log-time">[svc:${svc.port}]</span><span class="log-${svc.status === 'active' ? 'ok' : 'failed'}">${svc.status === 'active' ? 'ok' : 'failed'}</span><span class="log-task">${svc.name}: ${svc.status}</span></div>`).join('');
          if (latestReport.ports) logHtml += latestReport.ports.map(port => `<div class="log-line"><span class="log-time">[port:${port.port}]</span><span class="log-${port.reachable ? 'ok' : 'failed'}">${port.reachable ? 'ok' : 'failed'}</span><span class="log-task">${port.name}: ${port.reachable ? 'reachable' : 'unreachable'}</span></div>`).join('');
          logConsole.innerHTML = logHtml;
          document.getElementById('ansibleUpdateTime').textContent = 'Report: ' + jsonFiles[0].replace('report_', '').replace('.json', '');
        } else { document.getElementById('ansibleLog').innerHTML = '<div class="loading">No reports found</div>'; }
      } catch (e) { console.error('Failed to fetch Ansible report:', e); document.getElementById('ansibleLog').innerHTML = '<div class="loading">Failed to load Ansible reports</div>'; }
    }

    async function updateBackupStatus() {
      try {
        const res = await fetch(CONFIG.backupReportUrl);
        const data = await res.json();
        const now = new Date().toLocaleTimeString('ko-KR');
        ['salm', 'mgmt', 'db'].forEach(type => {
          const prefix = type === 'db' ? 'db' : type;
          const info = data[type];
          if (info) {
            document.getElementById(`${prefix}BackupOk`).textContent = info.success || 0;
            document.getElementById(`${prefix}BackupFailed`).textContent = info.failed || 0;
            document.getElementById(`${prefix}BackupTotal`).textContent = info.total || 0;
            document.getElementById(`${prefix}BackupTime`).textContent = 'Updated: ' + now;
            const logEl = document.getElementById(`${prefix}BackupLog`);
            if (info.files && info.files.length > 0) {
              logEl.innerHTML = info.files.slice(0, 5).map(f => `<div class="log-line"><span class="log-time">[${f.date || 'N/A'}]</span><span class="log-${f.status === 'ok' ? 'ok' : 'failed'}">${f.status}</span><span class="log-task">${f.name}</span><span class="log-size">${f.size || ''}</span></div>`).join('');
            } else { logEl.innerHTML = '<div class="loading">No backup files</div>'; }
          }
        });
      } catch (e) {
        console.error('Failed to fetch backup status:', e);
        ['salm', 'mgmt', 'db'].forEach(type => {
          document.getElementById(`${type}BackupLog`).innerHTML = '<div class="loading">Run backup playbook</div>';
        });
      }
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return `${seconds}Ï¥à Ï†Ñ`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}Î∂Ñ Ï†Ñ`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}ÏãúÍ∞Ñ Ï†Ñ`;
      return `${Math.floor(hours / 24)}Ïùº Ï†Ñ`;
    }

    const ctx = document.getElementById('cpuChart').getContext('2d');
    const cpuHistory = Array(12).fill(0);
    const labels = Array.from({length: 12}, (_, i) => `-${(11-i)*5}m`);
    const cpuChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'CPU %', data: cpuHistory, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 5, borderWidth: 2 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#1f2937' }, ticks: { color: '#9ca3af', font: { size: 10 } } }, y: { min: 0, max: 100, grid: { color: '#1f2937' }, ticks: { color: '#9ca3af', font: { size: 10 } } } } }
    });
    async function updateCpuChart() {
      const cpu = await fetchPrometheusMetric('100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)');
      if (cpu !== null) { cpuHistory.shift(); cpuHistory.push(cpu); cpuChart.update('none'); }
    }

    async function init() {
      await updateMetrics();
      await updateServiceStatus();
      await updateKubernetes();
      await updatePipeline();
      await updateAnsibleReport();
      await updateBackupStatus();
      await updateCpuChart();
      setInterval(updateMetrics, CONFIG.refreshInterval);
      setInterval(updateServiceStatus, CONFIG.refreshInterval);
      setInterval(updateKubernetes, CONFIG.refreshInterval);
      setInterval(updatePipeline, 60000);
      setInterval(updateAnsibleReport, 60000);
      setInterval(updateBackupStatus, 60000);
      setInterval(updateCpuChart, 30000);
    }
    init();
  </script>
</body>
</html>
